document.addEventListener('DOMContentLoaded', () => {
    const aiGenerateBtn = document.getElementById('ai-generate-btn-new');
    if (aiGenerateBtn) {
        aiGenerateBtn.addEventListener('click', handleAiGeneration);
    }
});

async function handleAiGeneration() {
    const apiKey = 'AIzaSyAkPS45eQkdmKrJkb-ExGOUDdxMzKhSGAY'; // User-provided API Key
    const promptInput = document.getElementById('ai-prompt-new');
    const resultDiv = document.getElementById('ai-result-new');
    const generateBtn = document.getElementById('ai-generate-btn-new');

    const userPrompt = promptInput.value;
    if (!userPrompt.trim()) {
        alert('Пожалуйста, введите ваш запрос в текстовое поле.');
        return;
    }

    // Disable button and show loading state
    generateBtn.disabled = true;
    generateBtn.textContent = 'Создание документа...';
    resultDiv.innerHTML = '<p class="k-placeholder">Пожалуйста, подождите, ИИ обрабатывает ваш запрос...</p>';

    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

    const systemPrompt = `
Ты — высококвалифицированный ИИ-ассистент, специализирующийся на составлении юридических документов в Казахстане. Твоя задача — сгенерировать полный, точный и юридически корректный текст Дополнительного соглашения к договору страхования на основе запроса пользователя.

**ИНСТРУКЦИИ:**
1.  **СТРОГОСТЬ И ФОРМАЛИЗМ:** Используй исключительно строгие, официальные и юридически выверенные формулировки. Не допускай разговорного стиля, упрощений или двусмысленности.
2.  **ПОЛНОТА ДОКУМЕНТА:** Сгенерированный текст должен представлять собой полноценное дополнительное соглашение. Он должен включать:
    *   **Преамбулу:** "Дополнительное соглашение №___" (оставь номер пустым), город (если не указан, используй "г. Алматы"), дата (если не указана, используй "«__» _______ 202__ г.").
    *   **Стороны:** Укажи стандартные формулировки для Страховщика (АО "Страховая компания 'Сентрас Иншуранс'") и Страхователя (если имя не указано в запросе, оставь плейсхолдер "___________________").
    *   **Предмет соглашения:** Четко укажи, что стороны вносят изменения в конкретный Договор страхования (используй номер и дату из запроса пользователя).
    *   **Пункты изменений:** Детально и точно изложи суть изменений, запрошенных пользователем. Каждый пункт должен быть пронумерован.
    *   **Заключительные положения:** Включи стандартные пункты о том, что соглашение вступает в силу с момента подписания, является неотъемлемой частью основного Договора, и составлено в двух экземплярах.
3.  **БЕЗ ДОМЫСЛОВ:** НИКОГДА не придумывай информацию. Если в запросе пользователя не хватает данных (например, номер договора, ФИО, конкретные даты), используй плейсхолдеры (например, "№_______", "от «__» _______ ____ г.", "ФИО: ______________").
4.  **ФОРМАТИРОВАНИЕ:** Используй четкое форматирование с нумерованными списками для пунктов и абзацами для разделения логических блоков.

**ПРИМЕР СТРУКТУРЫ:**

ДОПОЛНИТЕЛЬНОЕ СОГЛАШЕНИЕ № ____
к Договору [Вид страхования] № [Номер из запроса] от [Дата из запроса]

г. Алматы                                                               «__» _______ 202__ г.

АО «Страховая компания «Сентрас Иншуранс», именуемое в дальнейшем «Страховщик», в лице [Должность и ФИО представителя], с одной стороны, и
[ФИО/Наименование Страхователя], именуемый(ая) в дальнейшем «Страхователь», с другой стороны,
заключили настоящее Дополнительное соглашение о нижеследующем:

1. Основанием для заключения настоящего Дополнительного соглашения является [Основание из запроса, например, 'письмо Страхователя'].
2. Стороны договорились внести следующие изменения и дополнения в Договор:
   2.1. [Пункт 1 из запроса пользователя в строгой юридической формулировке]
   2.2. [Пункт 2 из запроса пользователя в строгой юридической формулировке]
3. Настоящее Дополнительное соглашение вступает в силу с даты его подписания обеими Сторонами.
4. Во всем остальном, что не предусмотрено настоящим Дополнительным соглашением, Стороны руководствуются условиями Договора.
5. Настоящее Дополнительное соглашение составлено в двух экземплярах, имеющих одинаковую юридическую силу, по одному для каждой из Сторон.

---
**ЗАПРОС ПОЛЬЗОВАТЕЛЯ:**
${userPrompt}
`;

    const requestBody = {
        contents: [{
            parts: [{
                text: systemPrompt
            }]
        }],
        generationConfig: {
            temperature: 0.4,
            topK: 1,
            topP: 1,
            maxOutputTokens: 2048,
        }
    };

    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody),
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`Ошибка API: ${response.status} ${response.statusText}. ${errorData.error.message}`);
        }

        const data = await response.json();
        const generatedText = data.candidates[0].content.parts[0].text;
        resultDiv.textContent = generatedText.trim();

    } catch (error) {
        console.error('Ошибка при вызове Gemini API:', error);
        resultDiv.innerHTML = `<p class="k-placeholder" style="color: #ff6b6b;">Произошла ошибка: ${error.message}<br><br>Пожалуйста, проверьте API-ключ и настройки сети.</p>`;
    } finally {
        // Re-enable button
        generateBtn.disabled = false;
        generateBtn.textContent = 'Создать документ';
    }
}
